From 652dbdc7e5cb546b2ab3f4aee060292963b5554c Mon Sep 17 00:00:00 2001
From: "matteo.lisi" <matteo.lisi@engicam.com>
Date: Thu, 5 Nov 2015 18:05:29 +0100
Subject: [PATCH] fix-uboot-env-geam6ul

---
 include/configs/common_parameter.h |  33 +++++++++-
 include/configs/geam6ul.h          | 122 +++----------------------------------
 2 files changed, 40 insertions(+), 115 deletions(-)

diff --git a/include/configs/common_parameter.h b/include/configs/common_parameter.h
index f3da544..a826e4c 100644
--- a/include/configs/common_parameter.h
+++ b/include/configs/common_parameter.h
@@ -14,7 +14,7 @@
 	#define CONFIG_SERVERIP		192.168.2.96
 	#define CONFIG_IPADDR		192.168.2.75
 	#define CONFIG_NETMASK		255.255.255.0
-	#define CONFIG_ETHADDR		61:aa:61:aa:61:aa
+	#define CONFIG_ETHADDR		9C:53:CD:01:21:6A
 
 	#if defined(CONFIG_SYS_BOOT_NAND)
 		#define CONFIG_BOOTCMD		"bootcmd=run bootcmd_ubi\0"
@@ -67,7 +67,6 @@
 		"mode=YOCTO_MODE\0"																	\
 		"mmcdev=0\0"																		\
 		"mmcpart=1\0"																		\
-		"fdt_addr=0x18000000\0" 																\
 
 	/* Customized parameter
 	 * Customized parameter for SODIMM iCore modules
@@ -91,6 +90,34 @@
 		"erase=nand erase 1c0000 4000\0"	\
 		"fdt_file=" CONFIG_DEFAULT_FDT_FILE "\0" 	\
 		"board=SK.RES\0"			\
+		"fdt_addr=0x18000000\0" 																\
+
+	/* Customized parameter
+	 * Customized parameter for SODIMM iCore modules
+	 */
+	#define	EXTRA_ENV_SETTINGS_ICOREUL 		\
+		"netdev=eth0\0" 			\
+		"ethprime=FEC0\0" 			\
+		"lcd_panel=Amp-WD\0" 			\
+		"nfsroot=/nfs_icore\0"			\
+		CONFIG_BOOTCMD				\
+		"loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}\0"											\
+		"bootargs=setenv bootargs console=" CONFIG_CONSOLE_DEV ",115200 cma=16M engi_board=${board} video=${video_type},${lcd_panel}\0"		\
+		"bootargsy_net=setenv bootargs ${bootargs} ${mtdparts_yocto} root=/dev/nfs ip=dhcp nfsroot=${serverip}:${nfsroot},v3,tcp\0" 				\
+		"bootcmd_net="  YOCTO_BOOTCMD_NET "\0"															\
+		"bootcmdy_net=" YOCTO_BOOTCMD_NET "\0"															\
+		"mmcdev=0\0"																		\
+		"mmcpart=1\0"					\
+		"bootargsy_ubi=setenv bootargs ${bootargs} ${mtdparts_yocto} ubi.mtd=3 root=ubi0:rootfs rootfstype=ubifs\0"			\
+		"bootargsy_mmc=setenv bootargs ${bootargs} ${mtdparts_yocto} root=/dev/mmcblk0p2 rootwait rw\0" 				\
+		"mtdparts_yocto=mtdparts=gpmi-nand:4m(boot),8m(kernel),1m(dtb),-(rootfs)\0"							\
+		"bootcmd_mmc="  YOCTO_BOOTCMD_MMC_ICORE "\0"											\
+		"bootcmd_ubi="  YOCTO_BOOTCMD_UBI 	"\0" 											\
+		"video_type=mxcfb0:dev=lcd\0"		\
+		"erase=nand erase 1c0000 4000\0"	\
+		"fdt_file=" CONFIG_DEFAULT_FDT_FILE "\0" 	\
+		"board=SK.RES\0"			\
+		"fdt_addr=0x83000000\0" 																\
 
 	/* Customized parameter
 	 * Customized parameter for QSEVEN RQS modules
@@ -114,6 +141,7 @@
 		"board=SK.Q7\0"				\
 		"fdt_file=" CONFIG_DEFAULT_FDT_FILE "\0" 	\
 		"mmcpart=1\0"				\
+		"fdt_addr=0x18000000\0" 																\
 		
 	/* Customized parameter
 	 * Customized parameter for SMARCORE modules
@@ -137,6 +165,7 @@
 		"board=SK.Q7\0"				\
 		"fdt_file=imx6sx-smarcore.dtb\0" 	\
 		"mmcpart=1\0"				\
+		"fdt_addr=0x18000000\0" 																\
 
 
 	/* Additional defines */
diff --git a/include/configs/geam6ul.h b/include/configs/geam6ul.h
index fb593e6..e5ac3ab 100644
--- a/include/configs/geam6ul.h
+++ b/include/configs/geam6ul.h
@@ -14,6 +14,10 @@
 #include "mx6_common.h"
 #include <asm/imx-common/gpio.h>
 
+#define CONFIG_CONSOLE_DEV		"ttymxc0"
+#define CONFIG_DEFAULT_FDT_FILE		"imx6ul-gea.dtb"
+#include "common_parameter.h"
+
 #define CONFIG_MX6
 #define CONFIG_ROM_UNIFIED_SECTIONS
 #define CONFIG_SYS_GENERIC_BOARD
@@ -147,120 +151,10 @@
 #define CONFIG_MFG_NAND_PARTITION ""
 #endif
 
-#ifdef CONFIG_VIDEO
-#define CONFIG_VIDEO_MODE \
-	"panel=Amp-WD\0"
-#else
-#define CONFIG_VIDEO_MODE ""
-#endif
-
-#define CONFIG_MFG_ENV_SETTINGS \
-	"mfgtool_args=setenv bootargs console=${console},${baudrate} " \
-		"rdinit=/linuxrc " \
-		"g_mass_storage.stall=0 g_mass_storage.removable=1 " \
-		"g_mass_storage.idVendor=0x066F g_mass_storage.idProduct=0x37FF "\
-		"g_mass_storage.iSerialNumber=\"\" "\
-		CONFIG_MFG_NAND_PARTITION \
-		"clk_ignore_unused "\
-		"\0" \
-	"initrd_addr=0x83800000\0" \
-	"initrd_high=0xffffffff\0" \
-	"bootcmd_mfg=run mfgtool_args;bootz ${loadaddr} ${initrd_addr} ${fdt_addr};\0" \
-
-#if defined(CONFIG_SYS_BOOT_NAND)
 #define CONFIG_EXTRA_ENV_SETTINGS \
-	CONFIG_MFG_ENV_SETTINGS \
-	CONFIG_VIDEO_MODE \
-	"fdt_addr=0x83000000\0" \
-	"fdt_high=0xffffffff\0"	  \
-	"console=ttymxc0\0" \
-	"bootargs=console=ttymxc0,115200 ubi.mtd=3 "  \
-		"root=ubi0:rootfs rootfstype=ubifs "		     \
-		"mtdparts=gpmi-nand:4m(boot),8m(kernel),1m(dtb),-(rootfs) cma=16MB\0"\
-	"bootcmd=nand read ${loadaddr} 0x400000 0x700000;"\
-		"nand read ${fdt_addr} 0xc00000 0x100000;"\
-		"bootm ${loadaddr} - ${fdt_addr}\0"
+	EXTRA_ENV_SETTINGS_ICOREUL \
+	"fdt_high=0xffffffff\0"
 
-#else
-#define CONFIG_EXTRA_ENV_SETTINGS \
-	CONFIG_MFG_ENV_SETTINGS \
-	CONFIG_VIDEO_MODE \
-	"script=boot.scr\0" \
-	"image=uImage\0" \
-	"console=ttymxc0\0" \
-	"fdt_high=0xffffffff\0" \
-	"initrd_high=0xffffffff\0" \
-	"fdt_file=imx6ul-gea.dtb\0" \
-	"fdt_addr=0x83000000\0" \
-	"boot_fdt=try\0" \
-	"ip_dyn=yes\0" \
- "bootcmd=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}; fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}; bootm ${loadaddr} - ${fdt_addr}\0" \
-        "bootargs=console=ttymxc0,115200  root=/dev/mmcblk0p2 rootwait rw mtdparts=gpmi-nand:4m(boot),8m(kernel),1m(dtb),-(rootfs) cma=16MB\0" \
-	"mmcdev="__stringify(CONFIG_SYS_MMC_ENV_DEV)"\0" \
-	"mmcpart=" __stringify(CONFIG_SYS_MMC_IMG_LOAD_PART) "\0" \
-	"mmcroot=" CONFIG_MMCROOT " rootwait rw\0" \
-	"mmcautodetect=yes\0" \
-	"mmcargs=setenv bootargs console=${console},${baudrate} " \
-		"root=${mmcroot}\0" \
-	"loadbootscript=" \
-		"fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${script};\0" \
-	"bootscript=echo Running bootscript from mmc ...; " \
-		"source\0" \
-	"loadimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}\0" \
-	"loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${fdt_file}\0" \
-	"mmcboot=echo Booting from mmc ...; " \
-		"run mmcargs; " \
-		"if test ${boot_fdt} = yes || test ${boot_fdt} = try; then " \
-			"if run loadfdt; then " \
-				"bootz ${loadaddr} - ${fdt_addr}; " \
-			"else " \
-				"if test ${boot_fdt} = try; then " \
-					"bootz; " \
-				"else " \
-					"echo WARN: Cannot load the DT; " \
-				"fi; " \
-			"fi; " \
-		"else " \
-			"bootz; " \
-		"fi;\0" \
-	"netargs=setenv bootargs console=${console},${baudrate} " \
-		"root=/dev/nfs " \
-	"ip=dhcp nfsroot=${serverip}:${nfsroot},v3,tcp\0" \
-		"netboot=echo Booting from net ...; " \
-		"run netargs; " \
-		"if test ${ip_dyn} = yes; then " \
-			"setenv get_cmd dhcp; " \
-		"else " \
-			"setenv get_cmd tftp; " \
-		"fi; " \
-		"${get_cmd} ${image}; " \
-		"if test ${boot_fdt} = yes || test ${boot_fdt} = try; then " \
-			"if ${get_cmd} ${fdt_addr} ${fdt_file}; then " \
-				"bootz ${loadaddr} - ${fdt_addr}; " \
-			"else " \
-				"if test ${boot_fdt} = try; then " \
-					"bootz; " \
-				"else " \
-					"echo WARN: Cannot load the DT; " \
-				"fi; " \
-			"fi; " \
-		"else " \
-			"bootz; " \
-		"fi;\0"
-
-#define CONFIG_BOOTCOMMAND \
-	   "mmc dev ${mmcdev};" \
-	   "mmc dev ${mmcdev}; if mmc rescan; then " \
-		   "if run loadbootscript; then " \
-			   "run bootscript; " \
-		   "else " \
-			   "if run loadimage; then " \
-				   "run mmcboot; " \
-			   "else run netboot; " \
-			   "fi; " \
-		   "fi; " \
-	   "else run netboot; fi"
-#endif
 
 /* Miscellaneous configurable options */
 #define CONFIG_SYS_LONGHELP
@@ -345,8 +239,10 @@
 #define	CONFIG_SF_DEFAULT_MODE		SPI_MODE_0
 #endif
 
+
+
 #if defined(CONFIG_ENV_IS_IN_MMC)
-#define CONFIG_ENV_OFFSET		(8 * SZ_64K)
+#define CONFIG_ENV_OFFSET		(16 * SZ_64K)
 #elif defined(CONFIG_ENV_IS_IN_SPI_FLASH)
 #define CONFIG_ENV_OFFSET		(768 * 1024)
 #define CONFIG_ENV_SECT_SIZE		(64 * 1024)
-- 
1.9.1

